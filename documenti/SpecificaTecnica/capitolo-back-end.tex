\section{Back-end}

\subsection{Interfaccia REST}

Ad ogni richiesta il server può rispondere con un messaggio di errore nel formato \glossario{JSON} e inviato con un codice \glossario{HTTP} della tipologia 4xx o 5xx. 
Il formato \glossario{JSON} del messaggio di errore sarà:
\begin{lstlisting}
{ 
  "code": [codice numerico dell'errore],
  "message": [descrizione testuale dell'errore],
  "data": [eventuali dati aggiuntivi sull'errore]
}
\end{lstlisting}
Di seguito sono elencate le risorse REST associate al tipo di metodo che è possibile richiedere su esse e i permessi richiesti per poter effettuare la richiesta. \\
I tipi di permessi possibili sono: 
\begin{itemize}
\item \textbf{Utente}: questa risorsa può essere richiesta da qualsiasi tipo di utente;
\item \textbf{Utente Autenticato}: questa risorsa può essere richiesta solo dagli utenti autenticati a \glossario{MaaP};
\item \textbf{Admin}: tale risorsa può essere richiesta solo da utenti con livello Admin.
\end{itemize}

\begin{center}
	\def\arraystretch{1.5}
	\bgroup
	\begin{longtable}{| p{8cm} | p{1.5cm} | p{4cm} |}
	\hline 
	
	\textbf{\emph{/profile}} & \textbf{GET} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} {Restituisce i dati relativi all'utente. }  \\ \hline
	\textbf{\emph{/profile}} & \textbf{POST} & \textbf{Utente} \\ \hline
	\multicolumn{3}{|c|} {Crea una nuova sessione associata all'utente, corrisponde al login.} \\ \hline
	\textbf{\emph{/profile}} & \textbf{PUT} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} { Modifica i dati utente. }  \\ \hline
	\textbf{\emph{/profile}} & \textbf{DELETE} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} {Elimina la sessione utente, corrisponde al logout. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/register}} & \textbf{POST} & \textbf{Utente} \\ \hline
	\multicolumn{3}{|c|} { Crea una richiesta di registrazione. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/dashboard}} & \textbf{GET} & \textbf{Utente} \\ \hline
	\multicolumn{3}{|c|} { Restituisce i dati da visualizzare nella dashboard. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/password/forgot}} & \textbf{POST} & \textbf{Utente} \\ \hline
	\multicolumn{3}{|c|} {Crea una richiesta di recupero password. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/users}} & \textbf{GET} & \textbf{Admin} \\ \hline
	\multicolumn{3}{|c|} {Restituisce la lista di tutti gli utenti. }  \\ \hline
	\textbf{\emph{/users}} & \textbf{POST} & \textbf{Admin} \\ \hline
	\multicolumn{3}{|c|} {Crea un nuovo utente. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/users/$\{$user id$\}$}} & \textbf{GET} & \textbf{Admin} \\ \hline
	\multicolumn{3}{|c|} {Restituisce i dati corrispondenti all'utente con id $\{$user id$\}$. }  \\ \hline
	\textbf{\emph{/users/$\{$user id$\}$}} & \textbf{PUT} & \textbf{Admin} \\ \hline
	\multicolumn{3}{|c|} {Modifica i dati dell'utente con id $\{$user id$\}$. }  \\ \hline
	\textbf{\emph{/users/$\{$user id$\}$}} & \textbf{DELETE} & \textbf{Admin} \\ \hline
	\multicolumn{3}{|c|} {Elimina l'utente con id $\{$user id$\}$. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/collection}} & \textbf{GET} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} {Restituisce la lista delle collection. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/collection/$\{$collection name$\}$} } & \textbf{GET} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} {Restituisce la lista di document della collection $\{$collection name$\}$.}  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/collection/$\{$collection name$\}$/$\{$document id$\}$}  } & \textbf{GET} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} {Restituisce la lista di attributi del Document $\{$document id$\}$ appartenente alla collection $\{$collection name$\}$}  \\ \hline
	\textbf{\emph{/collection/$\{$collection name$\}$/$\{$document id$\}$} } & \textbf{PUT} & \textbf{Admin} \\ \hline
	\multicolumn{3}{|c|} {Modifica il document $\{$document id$\}$. }  \\ \hline
	\textbf{\emph{\emph{/collection/$\{$collection name$\}$/$\{$document id$\}$} }} & \textbf{DELETE} & \textbf{Admin} \\
	\hline
	\multicolumn{3}{|c|} {Elimina il document con id $\{$document id$\}$. }  \\ \specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/action/$\{$action name$\}$/$\{$collection name$\}$}} & \textbf{PUT} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} {Esegue l'azione $\{$action name$\}$ sulla Collection $\{$collection name$\}$.}  \\ 
	\specialrule{1pt}{1pt}{1pt}
	
	\multicolumn{3}{c} {} \\ \hline
	
	\textbf{\emph{/action/$\{$action name$\}$/$\{$collection name$\}$/$\{$document id$\}$}} & \textbf{PUT} & \textbf{Utente Autenticato} \\ \hline
	\multicolumn{3}{|c|} {Esegue l'azione $\{$action name$\}$ sul Document $\{$document name$\}$ della Collection 
	$\{$collection name$\}$.}  \\ 
	\specialrule{1pt}{1pt}{1pt}

	
\end{longtable}
	  \egroup
\end{center}

\subsection{Descrizione packages e classi}

\input{backend-packages}

\subsection{Scenari}

In tutti i diagrammi di sequenza di questa sezione i messaggi inviati tra gli oggetti che compongono il Backend sono asincroni. In questo modo la gestione di qualsiasi richiesta non blocca il processo del server durante il recupero di risorse dal database o da disco. Questa è una delle scelte e caratteristiche fondamentali dell'ambiente Node.js e pertanto se ne è tenuto sin dall'inizio della progettazione.

\subsubsection{Gestione generale delle richieste}
Nel diagramma di sequenza che rappresenta lo scenario della gestione richieste viene mostrata l'iterazione tra server e middleware, alcuni dei quali sono offerti da Express, altri sono definiti dall'utente o da altre librerie. I \glossario{Middleware} si distinguono in Middleware di gestione delle richieste e Middleware di gestione degli errori, a seconda del numero di parametri con cui vengono invocati.

Segue un elenco ordinato dei middleware utilizzati. L'ordine in cui elaborano la richiesta è determinante, poiché ciascuno costituisce un handler del pattern Chain of Responsibility e ha la facoltà di interrompere la catena di chiamate.

\begin{itemize}
\item{express.compress()}: \glossario{Middleware} per comprimere  con il formato \glossario{gzip} le comunicazioni.
\item{express.logger()}: \glossario{Middleware} utilizzato per registrare un log delle richieste, utile per fare il
\glossario{debugging} dell'applicazione.
\item{express.json()}: \glossario{Middleware} che estrae dalle richiesta i parametri che sono nel formato JSON.
\item{express.urlencoded()}: \glossario{Middleware} che estrae dalle richiesta i parametri di tipo www-form-encoded, arrivati ad esempio con una richiesta POST.
\item{express.methodOverride()}: \glossario{Middleware} utilizzato per permettere anche ai vecchi browser di avere un modo per fare richieste PUT e DELETE.
\item{express.cookieParser()}: \glossario{Middleware} che analizza i \glossario{cookie}.
\item{express.cookieSession()}: \glossario{Middleware} per la gestione di sessioni utente basate su cookies.
\item{Authentication}: \glossario{Middleware} da noi scritto per gestire l'autenticazione. Utilizza nello specifico:
	\begin{itemize}
	\item{passport.initialize()}: \glossario{Middleware} utilizzato per l'inizializzazione di Passport.
	\item{passport.session()}:  \glossario{Middleware} che permette di memorizzare i record della sessione utente per mantenerne lo stato di login. 
	\end{itemize}
\item{express.router()}: \glossario{Middleware} con cui Express gestisce le richieste, smistandole a diversi controller in base alla URI e al metodo HTTP con cui sono state richieste (GET, PUT, POST, DELETE).
\item{express.static()}: \glossario{Middleware} per servire contenuti statici.
\item{NotFoundHandler}: un \glossario{Middleware} da noi scritto per gestire le richieste che non vengono gestite da nessun controller (errore client 404).
\item{ErrorHandler}: \glossario{Middleware} da noi scritto per gestire gli errori sollevati da uno dei precedenti middleware (errore server 500).
\end{itemize}

Nel seguente diagramma di sequenza viene rappresentata una generica richiesta al server. Le classi e il comportamento sono state progettate in funzione del design pattern della Chain of Responsibility che il framework Express utilizza internamente (si veda la sezione \ref{chain-of-responsibility}). Specificando meglio i possibili comportamenti del middleware, un middleware può terminare la propria esecuzione in tre diversi modi:

\begin{enumerate}
 \item Un middleware può terminare la propria esecuzione eseguendo la callback passatagli come parametro. Verranno quindi eseguiti i successivi middleware.
 
 \item In caso di errore, un middleware può eseguire la callback passandogli l'errore come parametro: \code{next(error)}. In questo modo la callback passerà il controllo al prossimo middleware della catena che è in grado di gestire un errore.
 
 \item Come terza alternativa, un middleware può terminare la propria esecuzione senza eseguire la callback. In questo caso la richiesta non verrà più gestita da nessun altro middleware.
\end{enumerate}

\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.27]{uml/scenari/Diagramma Gestione Richiesta.png}  
		\caption{Diagramma di sequenza per la gestione di una richiesta}
	\end{center}  
\end{figure} 

Nel seguente diagramma di sequenza viene mostrato il comportamento del middleware di routing, il quale internamente confronta l'uri della richiesta con alcune espressioni regolari per decidere a quale service passare il controllo.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.27]{uml/scenari/Diagramma Routing Richiesta.png} 
		\caption{Diagramma di sequenza per il routing di una richiesta}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Fallimento vincolo ``utente autenticato''}
Per ogni richiesta bisogna verificare che il permesso dell'utente che l'ha chiesta, corrisponda al permesso che la risorsa necessita per poter essere effettuata. \\
Tale scenario rappresenta il fallimento di una richiesta richiedente come vincolo per poter essere effettuata che l'utente abbia un permesso di tipo ''utente autenticato'', dove la verifica dei permessi è gestita dal controller \emph{requireLogged} che manda un next(error) per il fallimento di tale vincolo al router il quale avrà compito di gestirlo.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/requireLogged ERROR.png} 
		\caption{Fallimento vincolo ``utente autenticato''}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Fallimento vincolo ``utente non autenticato''}
Il seguente diagramma di sequenza rappresenta lo scenario in cui fallisce la verifica del vincolo di permesso ''utente autenticato''.
La richiesta viene gestita da \emph{requireNotLogged} che verifica con esito negativo i permessi e rimanda un next(error) al router.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/requireNotLogged ERROR.png} 
		\caption{Fallimento vincolo ``utente non autenticato''}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Fallimento vincolo ``utente admin''}
Nel diagramma seguente viene rappresentato lo scenario in cui si richiedono permessi ''Admin'' per poter gestire la richiesta corrispondente e la verifica effettuata dal controller \emph{requireAdmin} fallisce. 
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/requireAdmin ERROR.png} 
		\caption{Fallimento vincolo ``utente admin''}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Fallimento vincolo ``utente  super admin''}
Nel diagramma seguente viene rappresentato lo scenario in cui si richiedono permessi ''Super Admin'' per poter gestire la richiesta corrispondente e la verifica effettuata dal controller \emph{requireSuperAdmin} fallisce. 
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/requireSuperAdmin ERROR.png} 
		\caption{Fallimento vincolo ``utente super admin''}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta POST /profile} 
Il seguente scenario mostra la gestione di una richiesta POST per la risorsa profile, \emph{requireNotLogged} non risponde con errore, chiamando il successivo \glossario{middleware} \emph{login} che gestisce la verifica dei parametri e nell'opzione che questa fallisca, manda in risposta un next(error) che il router andrà a gestire.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/profile POST.png} 
		\caption{Richiesta POST /profile}
	\end{center} 
\end{figure} 

\pagebreak
\subsubsection{Richiesta DELETE /profile}
Il diagramma di sequenza mostra lo scenario di una richiesta DELETE per la risorsa profile.
La verifica dei permessi in \emph{requireLogged} non fallisce, innescando la chiamata al successivo \glossario{middleware} \emph{logout} che gestisce l'eliminazione della risorsa.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/profile DELETE.png} 
		\caption{Richiesta DELETE /profile}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta GET /profile}
Il seguente diagramma rappresenta lo scenario di una richiesta GET per ottenere la risorsa Profile, la verifica dei permessi non fallisce e la richiesta viene gestita da \emph{getProfile}.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Profile GET.png} 
		\caption{Richiesta GET /profile}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta PUT /profile} 
Viene rappresentato lo scenario di una richiesta PUT per la risorsa Profile, il \emph{requireLogged} non ritorna un errore, chiamando il successivo \glossario{middleware} \emph{editProfile} che gestisce la richiesta di modifica dei dati del profilo.
Nell'opzione che i parametri passati per la modifica del profilo siano errati, \emph{editProfile} chiamerà la callback passandogli la descrizione dell'errore come parametro che il router andrà a gestire.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Profile PUT.png} 
		\caption{Richiesta PUT /profile}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta POST /password/forgot} 
Viene rappresentato lo scenario di una richiesta POST per la risorsa password forgot, il \emph{requireNotLogged} non risponde errore e il controllo passa a \emph{passwordResetRequest} che gestisce la richiesta.
Se i parametri passati per la richiesta sono errati, il controllore \emph{requireNotLogged} risponderà con un errore.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Password Forgot POST.png} 
		\caption{Richiesta POST /password/forgot}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta GET /users}
Viene rappresentato nel seguente diagramma di sequenza lo scenario di una richiesta GET per la risorsa user, \emph{requireAdmin} non fallisce ed il controllo viene passato a \emph{getUsers} che gestisce la richiesta.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Users GET.png} 
		\caption{Richiesta GET /users}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta POST /users} 
Il seguente diagramma di sequenza rappresenta lo scenario di una richiesta POST per la risorsa user, la verifica di \emph{requireLogged} dei permessi utente non fallisce e viene passato il controllo a \emph{createUser} che gestisce la richiesta di creazione di un nuovo user, e nel caso la verifica dei parametri passati per la creazione di quest'ultimo siano errati, il controllore chiamerà la callback con l'errore.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Users POST.png} 
		\caption{Richiesta POST /users}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta GET /users/\{user id\}} 
Lo scenario rappresenta una richiesta GET di una risorsa User id, vengono verificati i permessi attraverso \emph{requireAdmin} che passa il controllo a \emph{getUser} dandogli come attributo l'id dell'user da restituire.
Nell'opzione che l'id dell'user sia errato, non corrispondendo a nessun user esistente, verrà richiamata una next(error).
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Users Id GET.png} 
		\caption{Richiesta GET /users/\{user id\}}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta PUT /users/\{user id\}} 
Nel seguente diagramma di sequenza viene rappresentato lo scenario di una richiesta PUT per la risorsa User id nel quale \emph{requireAdmin} non restituisce un errore e passa il controllo a \emph{editUser} che gestisce la richiesta di modifica dati dell'user corrispondente all'userId che gli è stato passato come attributo.
\emph{EditUser} verifica inoltre che l'userId passatogli come attributo non corrisponda all'id dello stesso user che ha effettuato la richiesta o corrisponda ad un id di un superAdmin e controlla che i parametri passati non siano errati, altrimenti risponderà con errore.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Users Id PUT.png} 
		\caption{Richiesta PUT /users/\{user id\}}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta DELETE /users/\{user id\}} 
Il diagramma di sequenza rappresenta lo scenario di una richiesta DELETE per la risorsa user id, \emph{requireAdmin} non restituisce un errore e la richiesta viene gestita da \emph{deleteUser} per procede con l'eliminazione dell'user cui id gli è stato passato come attributo.
Nell'opzione che l'id passatogli corrisponda all'id dell'utente che ha effettuato la richiesta o ad un id di un superAdmin, \emph{deleteUser} restituisce un next(error). Il controller si preoccupa inoltre di verificare che i parametri siano corretti.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Users Id DELETE.png} 
		\caption{Richiesta DELETE /users/\{user id\}}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta GET /collection} 
Il diagramma seguente rappresenta lo scenario di una richiesta GET per la risorsa collection, il controller \emph{requireLogged} innescherà la chiamata del successivo controller \emph{listCollection} che gestirà la richiesta di restituzione della lista di \glossario{Collection}.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Collection GET.png} 
		\caption{Richiesta GET /collection}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta GET /collection/\{collection name\}} 
Il diagramma seguente rappresenta lo scenario di una richiesta GET per la risorsa collection Name, il controller \emph{requireLogged} innescherà la chiamata del successivo controller \emph{indexPage} al quale verrà passato come parametro l'id della \glossario{Collection} per la restituzione dell'index page corrispondente. \\ 
Nell'opzione che l'id sia errato il controller chiamerà la callback passandogli la descrizione dell'errore come parametro.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Collection Name GET.png} 
		\caption{Richiesta GET /collection/\{collection name\}}
	\end{center} 
\end{figure}

\pagebreak
\subsubsection{Richiesta GET /collection/\{collection name\}/\{document id\}} 
Il diagramma di sequenza rappresenta lo scenario di una richiesta GET per la risorsa collection name document, nel quale al controller \emph{showpage} viene passato l'id del document di cui mostrare la show page.
Nell'opzione l'id sia errato, non corrispondendo ad un \glossario{Document} valido, \emph{showpage} restituisce una next(error).
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Collection Name Document GET.png}
		\caption{Richiesta GET /collection/\{collection name\}/\{document id\}}
	\end{center} 
\end{figure}


\pagebreak
\subsubsection{Richiesta DELETE /collection/\{collection name\}/\{document id\}}
Il seguente scenario rappresenta la richiesta DELETE per una risorsa Collection name document, dopo che i permessi sono stati verificati il controllo è passato a \emph{deleteDocument} il quale gestirà la richiesta di eliminazione del document il cui id gli è stato passato come parametro. Se l'id è errato, verrà restituito un errore.
\begin{figure}[H]
	\begin{center} 
		\includegraphics[scale=0.20]{uml/scenari/Collection Name Document DELETE.png} 
		\caption{Richiesta DELETE /collection/\{collection name\}/\{document id\}}
	\end{center} 
\end{figure}

\clearpage
\subsection{Descrizione librerie aggiuntive}

Vengono di seguito descritte le librerie aggiuntive utilizzate dal Back-end che corrispondono nei diagrammi precedenti ai packages colorati. La scelta è stata effettuata cercando di valutare la diffusione, il livello di stabilità, l'assenza di errori noti.

\begin{itemize}
 \item \textbf{Passport:} è un middleware di autenticazione per \glossario{Node.js}. Estremamente flessibile e modulare, Passport può essere facilmente inserito in qualsiasi applicazione web basata su Express.
 \item \textbf{Passport-local:} è una libreria che permette di autenticare un utente con Passport usando un username e una password.
 \item \textbf{Passport-local-mongoose:} è un plugin per Mongoose che semplifica la costruzione di un sistema di autenticazione con Passport.
 \item \textbf{Nodemailer:} è un modulo che permette di mandare facilmente e-mail con Node.js, tramite \glossario{SMTP}. Supporta anche i caratteri \glossario{unicode}.
 \item \ \textbf{Sweet:} è un modulo che permette di definire macro utilizzando la sintassi del linguaggio Javascript.
\end{itemize}